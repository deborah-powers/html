<!DOCTYPE html><html><head>
	<title></title>
	<meta name='viewport' content='width=device-width,initial-scale=1'/>
	<meta charset='utf-8'/>
	<base target='_blank'>
	<link rel='icon' type='image/svg+xml' href='file:///C:/wamp64/www/site-dp/data/nounours-perso.svg'/>
	<link rel='stylesheet' type='text/css' href='file:///C:/wamp64/www/site-dp/library-css/structure.css'/>
	<link rel='stylesheet' type='text/css' href='file:///C:/wamp64/www/site-dp/library-css/perso.css' media='screen'/>
	<script type='text/javascript' src='file:///C:/wamp64/www/site-dp/library-js/drag-drop.js'></script>
<style type='text/css'>
	canvas, div#frame {
		border-style: double;
		background-color: var(--text-color);
	}
	div {
		padding: 0;
		line-height: 0;
		position: relative;
		background-size: contain;
		margin: 1em;
	}
	section#frame-action {
		display: grid;
		grid-template-columns: 1fr 1fr 1fr 1fr;
		grid-template-rows: 2em 1fr;
	}
	div#frame >* {
		position: absolute;
		margin: 0;
		padding: 0;
		line-height: 0;
	}
	div.slider {
		display: flex;
		flex-direction: row;
	}
	div.slider:nth-child(5) { grid-column: 1/5; }
	div.slider:nth-child(6) { flex-direction: column; }
	input[type='range'] {
		writing-mode: horizontal-tb;
		width: 8em;
		appearance: none;
		accent-color: var(--text-color);
		background-color: none;
		cursor: pointer;
	}
	input[type='range'].vertical {
		writing-mode: vertical-lr;
		height: 8em;
	}
	input[type='range']::-webkit-slider-runnable-track, input[type='range']::-moz-range-track {
		background-color: var(--bord-color);
	}
	input[type='range']::-webkit-slider-thumb, input[type='range']::-moz-range-thumb {
		appearance: none;
		background-color: var(--fond-color);
		border: solid 2px var(--text-color);
		border-radius: 50%;
	}
	img {
		mix-blend-mode: normal;
		aspect-ratio: auto;
	}
	p {
		width: 2px;
		height: 100%;
		background-color: deeppink;
		display: inline-block;
	}
	p.vertical {
		width: 100%;
		height: 2px;
	}
</style></head><body>
	<section id='frame-result'>
		<input type='file' accept='image/png, image/jpg, image/bmp' />
		<a class='button' download='' href=''>télécharger</a>
		<canvas></canvas>
	</section>
	<section id='frame-action'>
		<button onclick='tumble90degree()'>basculer</button>
		<button onclick='rotateLeft()'>incliner à gauche</button>
		<button onclick='rotateRight()'>incliner à droite</button>
		<button onclick='validall()'>valider</button>
		<div class='slider'><input type='range' min='0' max='100' value='0' /><input type='range' min='0' max='100' value='100' /></div>
		<div class='slider'>
			<input type='range' min='0' max='100' value='0' class='vertical' />
			<input type='range' min='0' max='100' value='100' class='vertical' />
		</div>
		<div id='frame'>
			<img src=''>
			<p class='vertical'></p><p class='vertical'></p><p></p><p></p>
		</div>
	</section>
	<img src='' id='ref' style='display: none;' />
</body><script type='text/javascript'>
	const frames = document.getElementsByTagName ('section');
	const canvas = document.getElementsByTagName ('canvas')[0];
	const context = canvas.getContext ('2d');
	const imageModif = document.getElementsByTagName ('img')[0];
	const imageOriginal = document.getElementsByTagName ('img')[1];
	const imageFrame = document.getElementById ('frame');
	const downloadButton = document.getElementsByTagName ('a')[0];
	const uploader = document.getElementsByTagName ('input')[0];
	uploader.addEventListener ('change', function (event){
		const imgSrc = URL.createObjectURL (event.target.files[0]);
		imageModif.src = imgSrc;
		imageOriginal.src = imgSrc;
		const p= event.target.files[0].name.lastIndexOf ('.');
		downloadButton.download = event.target.files[0].name.substring (0,p) +' bis' + event.target.files[0].name.substring (p);
	});
	HTMLImageElement.prototype.adaptFrame = function (width, height){
		this.style.width = width + 'px';
		this.style.height = height + 'px';
		imageFrame.style.width = width + 'px';
		imageFrame.style.height = height + 'px';
		this.width = width;
		this.height = height;
	}
	imageOriginal.onload = function(){ imageModif.adaptFrame (300, this.height *300/ this.width); }
	function tumble90degree(){
		canvas.width = imageModif.height;
		canvas.height = imageModif.width;
		context.rotate (Math.PI /2);
		console.log (canvas.width, canvas.height, imageModif.width, imageModif.height);
	//	context.drawImage (imageModif, 0, - canvas.width);
		context.drawImage (imageModif, 0, - canvas.width, canvas.width, canvas.height);
		imageModif.src = canvas.toDataURL();
		imageModif.adaptFrame (canvas.width, canvas.height);
		console.log (imageModif.width, imageModif.height, imageModif.style.width, imageModif.style.height, canvas.width, canvas.height, imageFrame.style.width, imageFrame.style.height);
	}
	// bouger les lignes de recadrage
	Element.prototype.getInputsByType = function (typeName){ return []; }
	HTMLElement.prototype.getInputsByType = function (typeName){
		var inputs =[];
		var inputsTmp =[];
		for (var child of this.children){
			inputsTmp = child.getInputsByType (typeName);
			for (var res of inputsTmp) inputs.push (res);
		}
		return inputs;
	}
	HTMLInputElement.prototype.getInputsByType = function (typeName){
		if (this.type === typeName) return [ this, ];
		else return [];
	}
	const frameCrop = document.getElementById ('frame');
	const movingLines = frameCrop.getElementsByTagName ('p');
	const movingInputs = document.body.getInputsByType ('range');
	movingInputs[0].onchange = function(){ movingLines[0].style.top = this.value + '%'; }
	movingInputs[1].onchange = function(){ movingLines[1].style.top = this.value + '%'; }
	movingInputs[2].onchange = function(){ movingLines[2].style.left = this.value + '%'; }
	movingInputs[3].onchange = function(){ movingLines[3].style.left = this.value + '%'; }

/*	HTMLImageElement.prototype.reduceSize800pxh = function(){
		if (this.height >800){
			canvas.width = this.width *800/ this.height;
			canvas.height = 800;
			context.drawImage (this, 0,0, canvas.width, canvas.height);
			newImgSrc = canvas.toDataURL();
			this.src = newImgSrc;
			this.width = canvas.width;
			this.height = canvas.height;
	}}*/
	// incliner l'image
	var imgRotation =0;
	function launchRotate(){
		frames[0].style.display = 'none';
		frames[1].style.display = 'block';
		frames[2].style.display = 'none';
		const frameRotate = frames[1].getElementsByTagName ('div')[0];
		frameRotate.style.height = image.height + 'px';
		frameRotate.style.width = image.width + 'px';
	}
	function degreeTOradian (degree){ return degree * Math.PI / 180; }
	function degreeTOcos (degree){ return Math.cos (degree * Math.PI / 180); }
	function degreeTOsin (degree){ return Math.sin (degree * Math.PI / 180); }
	function validRotate(){
		const diag = Math.sqrt (image.width * image.width + image.height * image.height);
		const imgAngle = Math.atan (image.height / image.width);
		var ecartWidth =0;
		var ecartHeight =0;
		// hauteur, imgRotation >0
		if (imgRotation >0){
			canvas.width = degreeTOcos (imgRotation) * image.width - degreeTOcos (90+ imgRotation) * image.height;
			canvas.height = diag * (Math.sin (imgAngle + degreeTOradian (imgRotation)));
			// TODO centrer l'image
			ecartWidth = degreeTOcos (90+ imgRotation) * image.height;
			ecartHeight = - ecartWidth * degreeTOsin (- imgRotation);
			ecartWidth *= - degreeTOcos (- imgRotation);
		}
		else if (imgRotation <0){
			canvas.width = diag * (Math.cos (imgAngle + degreeTOradian (imgRotation)));
			canvas.height = degreeTOsin (90+ imgRotation) * image.height - degreeTOsin (imgRotation) * image.width;
			// TODO centrer l'image
			ecartHeight = degreeTOsin (imgRotation) * image.width;
			ecartWidth = - ecartHeight * degreeTOcos (90- imgRotation);
			ecartHeight *= - degreeTOsin (90- imgRotation);
		}
		// rotation
		context.rotate (degreeTOradian (imgRotation));
		context.drawImage (image, ecartWidth, ecartHeight);
		newImgSrc = canvas.toDataURL();
		image.src = newImgSrc;
		image.width = canvas.width;
		image.height = canvas.height;
		frames[0].style.display = 'none';
		frames[1].style.display = 'none';
		frames[2].style.display = 'block';
	}
	function rotateLeft(){
		imgRotation -=1;
		if (imgRotation <-90) imgRotation = -90;
		image.style.transform = 'rotate(' + imgRotation + 'deg)';
	}
	function rotateRight(){
		imgRotation +=1;
		if (imgRotation >90) imgRotation = 90;
		image.style.transform = 'rotateZ(' + imgRotation + 'deg)';
	}
</script></html>